<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  
  <title>Spring探究之AOP | Severin的博客</title>
  
  

  

  <meta name="HandheldFriendly" content="True" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <!-- meta -->
  

  <!-- link -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-waves@0.7.6/dist/waves.min.css">
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.10.1/css/all.min.css">
  

  
  <link rel="shortcut icon" type='image/x-icon' href="https://cdn.jsdelivr.net/gh/mike-zeng/zeng_cdn/blog/image/favicon.ico">
  

  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-material-x@19.11.26/css/style.css">

  

  <script>
    function setLoadingBarProgress(num) {
      document.getElementById('loading-bar').style.width=num+"%";
    }
  </script>

  
  
<meta name="generator" content="Hexo 4.2.0"></head>

<body>
  
  
  <div class="cover-wrapper">
    <cover class='cover post half'>
      
        
  <h1 class='title'>Severin</h1>


  <div class="m_search">
    <form name="searchform" class="form u-search-form">
      <input type="text" class="input u-search-input" placeholder="" />
      <i class="icon fas fa-search fa-fw"></i>
    </form>
  </div>

<div class='menu navgation'>
  <ul class='h-list'>
    
      
        <li>
          <a class="nav home" href="/"
            
            
            id="home">
            <i class='fas fa-rss fa-fw'></i>&nbsp;博文
          </a>
        </li>
      
        <li>
          <a class="nav home" href="/friends/"
            
              rel="nofollow"
            
            
            id="friends">
            <i class='fas fa-link fa-fw'></i>&nbsp;友链
          </a>
        </li>
      
        <li>
          <a class="nav home" href="/about/"
            
              rel="nofollow"
            
            
            id="about">
            <i class='fas fa-info-circle fa-fw'></i>&nbsp;关于
          </a>
        </li>
      
    
  </ul>
</div>

      
    </cover>
    <header class="l_header pure">
  <div id="loading-bar-wrapper">
    <div id="loading-bar" class="pure"></div>
  </div>

	<div class='wrapper'>
		<div class="nav-main container container--flex">
      <a class="logo flat-box" href='/' >
        
          Severin的博客
        
      </a>
			<div class='menu navgation'>
				<ul class='h-list'>
          
  					
  						<li>
								<a class="nav flat-box" href="/"
                  
                  
                  id="home">
									<i class='fas fa-grin fa-fw'></i>&nbsp;示例
								</a>
							</li>
      			
  						<li>
								<a class="nav flat-box" href="/categories/"
                  
                    rel="nofollow"
                  
                  
                  id="categories">
									<i class='fas fa-folder-open fa-fw'></i>&nbsp;分类
								</a>
							</li>
      			
  						<li>
								<a class="nav flat-box" href="/tags/"
                  
                    rel="nofollow"
                  
                  
                  id="tags">
									<i class='fas fa-hashtag fa-fw'></i>&nbsp;标签
								</a>
							</li>
      			
  						<li>
								<a class="nav flat-box" href="/archives/"
                  
                    rel="nofollow"
                  
                  
                  id="archives">
									<i class='fas fa-archive fa-fw'></i>&nbsp;归档
								</a>
							</li>
      			
      		
				</ul>
			</div>

			
				<div class="m_search">
					<form name="searchform" class="form u-search-form">
						<input type="text" class="input u-search-input" placeholder="Search" />
						<i class="icon fas fa-search fa-fw"></i>
					</form>
				</div>
			
			<ul class='switcher h-list'>
				
					<li class='s-search'><a class="fas fa-search fa-fw" href='javascript:void(0)'></a></li>
				
				<li class='s-menu'><a class="fas fa-bars fa-fw" href='javascript:void(0)'></a></li>
			</ul>
		</div>

		<div class='nav-sub container container--flex'>
			<a class="logo flat-box"></a>
			<ul class='switcher h-list'>
				<li class='s-comment'><a class="flat-btn fas fa-comments fa-fw" href='javascript:void(0)'></a></li>
        
          <li class='s-toc'><a class="flat-btn fas fa-list fa-fw" href='javascript:void(0)'></a></li>
        
			</ul>
		</div>
	</div>
</header>
	<aside class="menu-phone">
    <header>
		<nav class="menu navgation">
      <ul>
        
          
            <li>
							<a class="nav flat-box" href="/"
                
                
                id="home">
								<i class='fas fa-clock fa-fw'></i>&nbsp;近期文章
							</a>
            </li>
          
            <li>
							<a class="nav flat-box" href="/blog/archives/"
                
                  rel="nofollow"
                
                
                id="blogarchives">
								<i class='fas fa-archive fa-fw'></i>&nbsp;文章归档
							</a>
            </li>
          
            <li>
							<a class="nav flat-box" href="/projects/"
                
                
                id="projects">
								<i class='fas fa-code-branch fa-fw'></i>&nbsp;开源项目
							</a>
            </li>
          
            <li>
							<a class="nav flat-box" href="/friends/"
                
                  rel="nofollow"
                
                
                id="friends">
								<i class='fas fa-link fa-fw'></i>&nbsp;我的友链
							</a>
            </li>
          
            <li>
							<a class="nav flat-box" href="https://xaoxuu.com/wiki/material-x/"
                
                  rel="nofollow"
                
                
                id="https:xaoxuu.comwikimaterial-x">
								<i class='fas fa-book fa-fw'></i>&nbsp;主题文档
							</a>
            </li>
          
            <li>
							<a class="nav flat-box" href="/about/"
                
                  rel="nofollow"
                
                
                id="about">
								<i class='fas fa-info-circle fa-fw'></i>&nbsp;关于小站
							</a>
            </li>
          
       
      </ul>
		</nav>
    </header>
	</aside>
<script>setLoadingBarProgress(40);</script>

  </div>


  <div class="l_body">
    <div class='body-wrapper'>
      <div class='l_main'>
  

  <article id="post" class="post white-box article-type-post" itemscope itemprop="blogPost">
    


  <section class='meta'>
    
    
    <div class="meta" id="header-meta">
      
        
  
    <h1 class="title">
      <a href="/2020/01/30/Spring%E6%8E%A2%E7%A9%B6%E4%B9%8BAOP/">
        Spring探究之AOP
      </a>
    </h1>
  


      
      <div class='new-meta-box'>
        
          
        
          
            
  <div class='new-meta-item author'>
    
      <a href="https://www.severin.xyz" rel="nofollow">
        
          <i class="fas fa-user" aria-hidden="true"></i>
        
        <p>Severin</p>
      </a>
    
  </div>


          
        
          
            <div class="new-meta-item date">
  <a class='notlink'>
    <i class="fas fa-calendar-alt" aria-hidden="true"></i>
    <p>2020-01-30</p>
  </a>
</div>

          
        
          
            
  
  <div class='new-meta-item category'>
    <a href='/categories/%E6%A1%86%E6%9E%B6/spring/' rel="nofollow">
      <i class="fas fa-folder-open" aria-hidden="true"></i>
      <p>框架&nbsp;/&nbsp;spring</p>
    </a>
  </div>


          
        
          
            
  
    <div class="new-meta-item browse busuanzi">
      <a class='notlink'>
        <i class="fas fa-eye" aria-hidden="true"></i>
        <p>
          <span id="busuanzi_value_page_pv">
            <i class="fas fa-spinner fa-spin fa-fw" aria-hidden="true"></i>
          </span>
        </p>
      </a>
    </div>
  


          
        
          
            
  
    <div class="new-meta-item wordcount">
      <a class='notlink'>
        <i class="fas fa-keyboard" aria-hidden="true"></i>
        <p>字数统计:</p>
        <p>3.1k字</p>
      </a>
    </div>
    <div class="new-meta-item readtime">
      <a class='notlink'>
        <i class="fas fa-hourglass-half" aria-hidden="true"></i>
        <p>阅读时长≈</p>
        <p>13分</p>
      </a>
    </div>
  

          
        
          
            

          
        
      </div>
      
        <hr>
      
    </div>
  </section>


    <section class="article typo">
      <div class="article-entry" itemprop="articleBody">
        <h5 id="1-什么是AOP"><a href="#1-什么是AOP" class="headerlink" title="1. 什么是AOP"></a>1. 什么是AOP</h5><blockquote>
<p>Aspect-oriented Programming (AOP) complements Object-oriented Programming (OOP) by providing another way of thinking about program structure. The key unit of modularity in OOP is the class, whereas in AOP the unit of modularity is the aspect. Aspects enable the modularization of concerns (such as transaction management) that cut across multiple types and objects. (Such concerns are often termed “crosscutting” concerns in AOP literature.)</p>
</blockquote>
<p>上面是Spring官网对AOP的解释，大致的意思是：面向方面编程通过提供另一种考虑程序结构的方式补充了面向对象编程。OOP中模块化的关键单元是类，而在AOP中模块化的单元是方面。方面支持跨多个类型和对象的关注点的模块化。</p>
<p>官方术语好像看不懂，接下来看下面这个例子：</p>
<pre><code class="java">@RestController
public class MyTestController {
    @GetMapping(&quot;/hello&quot;)
    public String hello(){
        try {
            // 模拟方法执行的时间
            System.out.println(&quot;方法执行...&quot;);
            Thread.sleep((long) (Math.random()*2000));
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        return &quot;success&quot;;
    }
}</code></pre>
<p>上面的方法是一个很简单的Handler用来处理http请求，现在的要求是用日志打印出这个handler处理时间。很显然只需要在业务的前面和后面增加一个获取当前时间的代码，最后计算两个值的差，就像下面这个方法一样。</p>
<pre><code class="java">@RestController
public class MyTestController {
    @GetMapping(&quot;/hello&quot;)
    public String hello(){
        // 求开始时间
        long starTime=System.currentTimeMillis();
        try {
            // 模拟方法执行的时间
            System.out.println(&quot;方法执行...&quot;);
            Thread.sleep((long) (Math.random()*2000));
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        // 求结束时间
        long endTime=System.currentTimeMillis();
        // 计算消耗的时间
        System.out.println(&quot;all time:&quot;+(endTime-starTime)+&quot;ms&quot;);
        return &quot;success&quot;;
    }
}</code></pre>
<p>但是一个web应用可能涉及到数十上百的handler，如果现在要求每个handler都要拥有打印运行时间的要求，如何实现呢？以OOP编程思想来看，只有在每一个类中都写重复的代码，显然这些冗余的代码会在后期维护时带来问题，比如有一天要求所有handler都不用打印运行时间，那就只能去每一个类里面找到这些代码逐行删除了。</p>
<p>其实上面的问题在于，有一些功能与业务无关，但是却需要应用到多个类中，如果使用传统的OOP思想，只能够在每个类的方法中都添加相同的代码，这些代码散落在各个类中，且与业务无关，难以维护。</p>
<p>那么看一下AOP是怎么解决这个问题的。</p>
<p> 本文使用的是Spring Boot，Spring Boot开启注解的方式很简单。首先添加starter</p>
<pre><code class="xml">  &lt;dependency&gt;
          &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-aop&lt;/artifactId&gt;
  &lt;/dependency&gt;</code></pre>
<p>然后只需要在Spring Boot的启动类中添加注解@EnableAspectProxy代理即可（不加注解也可以）</p>
<pre><code class="java">@Aspect
@Component
public class RunTimeAspect {
    @Pointcut(&quot;execution(* site.zeng.demo.springbootstudy.aoptest.controller.*.*(..))&quot;)
    public void runTimePointCut(){}

    @Around(&quot;runTimePointCut()&quot;)
    public Object printRunTime(ProceedingJoinPoint joinPoint){
        Object ret=null;
        System.out.println(&quot;hello&quot;);
        try {
            long startTime=System.currentTimeMillis();
            ret = joinPoint.proceed();
            long endTime=System.currentTimeMillis();
            System.out.println(&quot;all time:&quot;+(endTime-startTime)+&quot;ms&quot;);
        } catch (Throwable throwable) {
            throwable.printStackTrace();
        }
        return ret;
    }
}</code></pre>
<p>只需要实现上面这个类就可以统计所有的handler中方法的执行时间，并且也只需在这个类中进行修改就可以改变功能。</p>
<p>通过上面的例子我们大概可以总结一下AOP的思想：</p>
<p>AOP编程思想是对OOP编程思想的一种补充，解决了OOP难以解决的问题，在OOP编程中，模块化的单位是类，当需要实现业务功能时是依靠不同类的对象的方法采用从上至下的方式组合而成，比如一个普通的web应用程序，业务功能的实现是从controller层到service层再到dao层，这种良好的分层结构使得代码的耦合性降低，但是有一类与业务无关的方法可能会散落再每一层的各个类中，比如一个统计方法运行时间的代码，如果我们的需求是作用再每一个controller方法中，或者指定的某些方法中，那么我们就需要将重复的代码写多编，显然这样会带来几个问题，第一个是散落的代码难以维护，第二个是业务无关的代码与业务代码发生了耦合。而AOP就可以解决这样的问题，AOP关注的不是某一个类或者式某一个方法，而是关注的是一系列方法运行的某些点，比如方法调用前，方法调用后等等，这样就可以使用AOP在这些散落在各个类的关注点增加类方法的功能，其基本的做法是使用一些表达式来描述这些位置，然后使用方法对这些位置进行增强，这样的好处是，不在需要将与业务无关的代码与业务代码耦合再一起，第二是这些与业务无关的代码可以集中写在一个地方，而不需要把它重复写在各个类中，使得代码更加容易维护。</p>
<h5 id="2-AOP的基本使用"><a href="#2-AOP的基本使用" class="headerlink" title="2. AOP的基本使用"></a>2. AOP的基本使用</h5><p>使用AOP只需要掌握三个知识点：AOP的基本概念，表达式的规范，通知的类型。</p>
<p><strong>AOP的基本概念</strong></p>
<ul>
<li>Aspect</li>
<li>Join Point</li>
<li>Advice</li>
<li>Poincut</li>
<li>Introduction</li>
<li>Target Object</li>
<li>Aop proxt</li>
<li>Weaving</li>
</ul>
<p><strong>表达式规范</strong></p>
<p><strong>通知类型</strong></p>
<h5 id="3-AOP源码分析"><a href="#3-AOP源码分析" class="headerlink" title="3. AOP源码分析"></a>3. AOP源码分析</h5><p>总所周知，AOP的实现靠的时JDK的Proxy类和Cglib（真的是众所周知），那么我们来用代码验证一下全部过程。既然我们都知道Spring AOP会生成代理对象，那么一定会经历这样一个流程，在获取bean对象的某一步会先创建一个非代理类对象，然后调用某些方法生成代理对象，我们的目标就是找到这个调用点。</p>
<p>一个简单的Demo:</p>
<pre><code class="java">@SpringBootApplication
@EnableAspectJAutoProxy
public class SpringBootAopApplication {
    public static void main(String[] args) {
        ConfigurableApplicationContext context = new SpringApplicationBuilder(SpringBootAopApplication.class)
                .web(WebApplicationType.NONE).run(args);
        // 通过beanName从容器中获取bean对象
        DemoBean bean = (DemoBean) context.getBean(&quot;demoBean&quot;);
        bean.test();
    }
}</code></pre>
<p>这里的DemoBean这个bean对象的作用域是prototype，这意味着获取bean不能从单例池中获取而是要重新创建。</p>
<p>进入<code>context.getBean(&quot;demoBean&quot;)</code>方法</p>
<pre><code class="java">//所属类：AbstractApplicationContext
public Object getBean(String name) throws BeansException {
    assertBeanFactoryActive();
    return getBeanFactory().getBean(name);
}</code></pre>
<p>继续进入<code>getBeanFactory().getBean(name)</code>方法</p>
<pre><code class="java">public Object getBean(String name) throws BeansException {
    return doGetBean(name, null, null, false);
}</code></pre>
<p>继续进入<code>doGetBean(name, null, null, false);</code>方法</p>
<pre><code class="java">protected &lt;T&gt; T doGetBean(final String name, @Nullable final Class&lt;T&gt; requiredType,
            @Nullable final Object[] args, boolean typeCheckOnly) throws BeansException {

        final String beanName = transformedBeanName(name);
        Object bean;
        // 从单例池中获取对象，如果存在就返回
        Object sharedInstance = getSingleton(beanName);
        if (sharedInstance != null &amp;&amp; args == null) {
            // 省略日志代码
            bean = getObjectForBeanInstance(sharedInstance, name, beanName, null);
        }
        else {
            // 当前正在创建这个bean，说明出现了循环引用并且无法解决，如何解决循环引用？
            if (isPrototypeCurrentlyInCreation(beanName)) {
                throw new BeanCurrentlyInCreationException(beanName);
            }

            // 检查bean所对应的定义BeanDefinition是否在容器中
            BeanFactory parentBeanFactory = getParentBeanFactory();
            if (parentBeanFactory != null &amp;&amp; !containsBeanDefinition(beanName)) {
                // 如果找不到就找其父容器，这部分代码省略
            }
            // 省略部分代码
            try {
                final RootBeanDefinition mbd = getMergedLocalBeanDefinition(beanName);
                checkMergedBeanDefinition(mbd, beanName, args);

                // 保证当前bean所依赖的bean初始化
                String[] dependsOn = mbd.getDependsOn();
                if (dependsOn != null) {
                    // 这部分代码省略，与我们的目标无关
                }
                // 下面这个if选择语句时根据bean的类型去决定后面的操作，我们只考虑prototype类型的
                if (mbd.isSingleton()) {
                    // 这里省略处理的代码
                }
                else if (mbd.isPrototype()) {
                    Object prototypeInstance = null;
                    try {
                           // 在创建bean之前进行某些操作 这里先不管
                        beforePrototypeCreation(beanName);
                        // 这里创建bean的实例，经过debug发现，返回值已经是代理对象
                        prototypeInstance = createBean(beanName, mbd, args);// 下一步分析
                    }
                    // 省略
                }
                // 后面代码与目标无关，全部省略
        }</code></pre>
<p>继续进入<code>createBean(beanName, mbd, args)</code>方法</p>
<pre><code class="java">    @Override
    protected Object createBean(String beanName, RootBeanDefinition mbd, @Nullable Object[] args)
            throws BeanCreationException {

        if (logger.isTraceEnabled()) {
            logger.trace(&quot;Creating instance of bean &#39;&quot; + beanName + &quot;&#39;&quot;);
        }
        RootBeanDefinition mbdToUse = mbd;
        // 通过bean的名称获取class对象
        Class&lt;?&gt; resolvedClass = resolveBeanClass(mbd, beanName);
        if (resolvedClass != null &amp;&amp; !mbd.hasBeanClass() &amp;&amp; mbd.getBeanClassName() != null) {
            mbdToUse = new RootBeanDefinition(mbd);
            mbdToUse.setBeanClass(resolvedClass);
        }
        // 
        try {
            // Give BeanPostProcessors a chance to return a proxy instead of the target bean instance.
            // 上面的官方注释的翻译是：给beanpostprocessor一个机会来返回代理而不是目标bean实例
            // 到此我为止我们知道了产生代理的过程与beanpostprocessor有关
            // 进入下一步，目标越来越清晰了,不信的是这个方法返回了null，所以需要继续分析
            Object bean = resolveBeforeInstantiation(beanName, mbdToUse);
            if (bean != null) {
                return bean;
            }
        }
        // 异常处理代码省略

        try {
            // 创建bean实例，由于后面直接返回了，所以需要进入这个方法
            Object beanInstance = doCreateBean(beanName, mbdToUse, args);
            // 日志代码省略
            // 返回bean实例
            return beanInstance;
        }
        // 后面代码全部省略
    }</code></pre>
<p>继续进入<code>doCreateBean(beanName, mbdToUse, args)</code></p>
<pre><code class="java">    protected Object doCreateBean(final String beanName, final RootBeanDefinition mbd, final @Nullable Object[] args)
            throws BeanCreationException {        
        // 前面代码全部省略
        // Initialize the bean instance. 初始化bean实例，此时bean不是代理对象
        // 而这个方法返回值确实exposedObject，所以肯定后面作了某些操作
        Object exposedObject= bean;
        try {
            populateBean(beanName, mbd, instanceWrapper);
            // debug发现这一步返回的是一个代理对象
            exposedObject = initializeBean(beanName, exposedObject, mbd);// 下一步进入
        }
        // 后面代码省略
        return exposedObject;
    }</code></pre>
<p>继续进入<code>initializeBean(beanName, exposedObject, mbd)</code></p>
<pre><code class="java">    protected Object initializeBean(final String beanName, final Object bean, @Nullable RootBeanDefinition mbd) {
        // 前面代码省略
        if (mbd == null || !mbd.isSynthetic()) {
            // 这一步返回了代理对象，继续深入
            wrappedBean = 
                applyBeanPostProcessorsAfterInitialization(wrappedBean, beanName);
        }

        return wrappedBean;
    }</code></pre>
<p>接下来进入<code>applyBeanPostProcessorsAfterInitialization(wrappedBean, beanName)</code></p>
<pre><code class="java">@Override
    public Object applyBeanPostProcessorsAfterInitialization(Object existingBean, String beanName)
            throws BeansException {

        Object result = existingBean;
        for (BeanPostProcessor processor : getBeanPostProcessors()) {
            Object current = processor.postProcessAfterInitialization(result, beanName);
            if (current == null) {
                return result;
            }
            result = current;
        }
        return result;
    }</code></pre>
<p>首先代码没有手动添加任何<code>BeanPostProcessor</code>对象，那么我们看一下容器自身有哪些<code>BeanPostProcessor</code>，其中有一个一定与动态代理有关。</p>
<img src="https://severinblog-1257009269.cos.ap-guangzhou.myqcloud.com/Spring%E5%8E%9F%E7%90%86/clipboard_20200225095722.png" style="zoom: 50%;" />

<p>框出来的那个类看上去就和生成代理对象有关，debug发现确实与这个对象有关。</p>
<p>至此我们知道了生成代理对象与<code>AnnotationAwareAspectJAutoProxyCreator</code>的实例有关，接下来的分析过程很简单，只需要研究这个类即可。首先看一下类的继承关系。</p>
<p><img src="https://severinblog-1257009269.cos.ap-guangzhou.myqcloud.com/Spring%E5%8E%9F%E7%90%86/AnnotationAwareAspectJAutoProxyCreator.png" alt=""></p>
<p>可以看到<code>AnnotationAwareAspectAutoProxyCreator</code>是<code>AbstractAutoProxyCreator</code>的子类，并且也是<code>BeanPostProcessor</code>的实现类。</p>
<p>只要探究一下<code>AnnotationAwareAspectAutoProxyCreator</code>的方法就可以知道如何生成代理的。</p>
<pre><code class="java">public Object postProcessAfterInitialization
       (@Nullable Object bean, String beanName) {
    if (bean != null) {
        Object cacheKey = getCacheKey(bean.getClass(), beanName);
        if (this.earlyProxyReferences.remove(cacheKey) != bean) {
            // 返回代理对象
            return wrapIfNecessary(bean, beanName, cacheKey);
        }
    }
    return bean;
}</code></pre>
<pre><code class="java">protected Object wrapIfNecessary(Object bean, String beanName, Object cacheKey) {
        if (StringUtils.hasLength(beanName) &amp;&amp; this.targetSourcedBeans.contains(beanName)) {
            return bean;
        }
        if (Boolean.FALSE.equals(this.advisedBeans.get(cacheKey))) {
            return bean;
        }
        if (isInfrastructureClass(bean.getClass()) || shouldSkip(bean.getClass(), beanName)) {
            this.advisedBeans.put(cacheKey, Boolean.FALSE);
            return bean;
        }

        // Create proxy if we have advice.
        Object[] specificInterceptors = getAdvicesAndAdvisorsForBean(bean.getClass(), beanName, null);
        if (specificInterceptors != DO_NOT_PROXY) {
            this.advisedBeans.put(cacheKey, Boolean.TRUE);
            // 生成代理对象的语句，下一步分析
            Object proxy = createProxy(
                    bean.getClass(), beanName, specificInterceptors, new SingletonTargetSource(bean));
            this.proxyTypes.put(cacheKey, proxy.getClass());
            return proxy;
        }

        this.advisedBeans.put(cacheKey, Boolean.FALSE);
        return bean;
    }</code></pre>
<pre><code class="java">protected Object createProxy(Class&lt;?&gt; beanClass, @Nullable String beanName,
            @Nullable Object[] specificInterceptors, TargetSource targetSource) {
        // 前面代码省略
        // 继续深入
        return proxyFactory.getProxy(getProxyClassLoader());
    }
</code></pre>
<pre><code class="java">public Object getProxy(@Nullable ClassLoader classLoader) {
        return createAopProxy().getProxy(classLoader);
}</code></pre>
<pre><code class="java">protected final synchronized AopProxy createAopProxy() {
        if (!this.active) {
            activate();
        }
        return getAopProxyFactory().createAopProxy(this);
}</code></pre>
<pre><code class="java">public AopProxy createAopProxy(AdvisedSupport config) throws AopConfigException {
        if (config.isOptimize() || config.isProxyTargetClass() || hasNoUserSuppliedProxyInterfaces(config)) {
            // 获取被代理的对象的Class对象
            Class&lt;?&gt; targetClass = config.getTargetClass();
            if (targetClass == null) {
                // 抛出异常省略
            }
            if (targetClass.isInterface() || Proxy.isProxyClass(targetClass)) {
                // jdk代理对象
                return new JdkDynamicAopProxy(config);
            }
            // cglib代理对象
            return new ObjenesisCglibAopProxy(config);
        }
        else {
            return new JdkDynamicAopProxy(config);
        }
    }</code></pre>
<p>到此为止大功告成，我们找到了如何生成AOP代理对象。</p>
<h5 id="4-AOP总结"><a href="#4-AOP总结" class="headerlink" title="4. AOP总结"></a>4. AOP总结</h5><p>Aop的实现与IoC容器有关，Ioc容器在实现的时候提供了<code>BeanPostProcessor</code>接口供用户实现，这个类的作用是在IoC容器创建bean实例之后提供一个机会给用户去改变这个bean，<code>BeanPostProcessor</code>有两个接口，一个是<code>postProcessBeforeInitialization</code>方法，另一个是<code>postProcessAfterInitialization</code>方法，前者在创建完bean实例之后，调用初始化方法之前调用，后再在初始化方法调用完之后再调用，这两个方法的参数都是传入一个bean，然后返回值也是一个bean，这样就可以在方法中对bean进行操作甚至是修改替换，然后返回。而Aop正是利用这个接口实现的，AOP实现了一个叫做AbstractAutoProxyCreator抽象类，这个抽象类的子类以不同的方式实现AOP，比如常见的使用注解那一套，就对应着子类<code>AnnotaionAwareAspectAutoProxyCreator</code>。AOP会根据bean实例的特点选择不同的方式生成动态代理，比如如果bean实现了接口接口，那么就使用JDK的Proxy类，否则会使用Cglib实现。</p>

      </div>
      
        <br>
        <center>感谢你对我的支持！<br><fancybox><img style="width:200px; height:200px; border-radius:50%;" src="https://cdn.jsdelivr.net/gh/mike-zeng/zeng_cdn/blog/image/reward.png"/></fancybox></center>
      
      
        <br>
        


  <section class='meta' id="footer-meta">
    <div class='new-meta-box'>
      
        
          <div class="new-meta-item date" itemprop="dateUpdated" datetime="2020-02-26T09:46:13+08:00">
  <a class='notlink'>
    <i class="fas fa-clock" aria-hidden="true"></i>
    <p>updated at Feb 26, 2020</p>
  </a>
</div>

        
      
        
          
  
  <div class="new-meta-item meta-tags"><a class="tag" href="/tags/%E6%A1%86%E6%9E%B6/" rel="nofollow"><i class="fas fa-tag" aria-hidden="true"></i><p>框架</p></a></div> <div class="new-meta-item meta-tags"><a class="tag" href="/tags/spring/" rel="nofollow"><i class="fas fa-tag" aria-hidden="true"></i><p>spring</p></a></div> <div class="new-meta-item meta-tags"><a class="tag" href="/tags/%E5%8E%9F%E7%90%86/" rel="nofollow"><i class="fas fa-tag" aria-hidden="true"></i><p>原理</p></a></div>


        
      
        
          
  <div class="new-meta-item share -mob-share-list">
  <div class="-mob-share-list share-body">
    
      
        <a class="-mob-share-qq" title="QQ好友" rel="external nofollow noopener noreferrer"
          
          href="http://connect.qq.com/widget/shareqq/index.html?url=https://www.severin.xyz/2020/01/30/Spring%E6%8E%A2%E7%A9%B6%E4%B9%8BAOP/&title=Spring探究之AOP | Severin的博客&summary="
          
          >
          
            <img src="https://cdn.jsdelivr.net/gh/xaoxuu/assets@19.1.9/logo/128/qq.png">
          
        </a>
      
    
      
        <a class="-mob-share-qzone" title="QQ空间" rel="external nofollow noopener noreferrer"
          
          href="https://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=https://www.severin.xyz/2020/01/30/Spring%E6%8E%A2%E7%A9%B6%E4%B9%8BAOP/&title=Spring探究之AOP | Severin的博客&summary="
          
          >
          
            <img src="https://cdn.jsdelivr.net/gh/xaoxuu/assets@19.1.9/logo/128/qzone.png">
          
        </a>
      
    
      
        <a class="-mob-share-weibo" title="微博" rel="external nofollow noopener noreferrer"
          
          href="http://service.weibo.com/share/share.php?url=https://www.severin.xyz/2020/01/30/Spring%E6%8E%A2%E7%A9%B6%E4%B9%8BAOP/&title=Spring探究之AOP | Severin的博客&summary="
          
          >
          
            <img src="https://cdn.jsdelivr.net/gh/xaoxuu/assets@19.1.9/logo/128/weibo.png">
          
        </a>
      
    
  </div>
</div>



        
      
    </div>
  </section>


      
      
          <div class="prev-next">
              
                  <section class="prev">
                      <span class="art-item-left">
                          <h6><i class="fas fa-chevron-left" aria-hidden="true"></i>&nbsp;Previous</h6>
                          <h4>
                              <a href="/2020/02/01/TCP%E6%8A%93%E5%8C%85%E6%8E%A2%E7%A9%B6/" rel="prev" title="TCP抓包探究">
                                
                                    TCP抓包探究
                                
                              </a>
                          </h4>
                          
                      </span>
                  </section>
              
              
                  <section class="next">
                      <span class="art-item-right" aria-hidden="true">
                          <h6>Next&nbsp;<i class="fas fa-chevron-right" aria-hidden="true"></i></h6>
                          <h4>
                              <a href="/2020/01/10/Linux%E4%BA%94%E7%A7%8DIO%E6%A8%A1%E5%9E%8B%E4%B8%8EJava%E4%B8%89%E7%A7%8DIO%E6%A8%A1%E5%9E%8B/" rel="prev" title="Linux五种IO模型与Java三种IO模型">
                                  
                                      Linux五种IO模型与Java三种IO模型
                                  
                              </a>
                          </h4>
                          
                              
                              <h6 class="tags">
                                  <a class="tag" href="/tags/java/"><i class="fas fa-tag fa-fw" aria-hidden="true"></i> java</a> <a class="tag" href="/tags/io/"><i class="fas fa-tag fa-fw" aria-hidden="true"></i> io</a>
                              </h6>
                          
                      </span>
                  </section>
              
          </div>
      
    </section>
  </article>



  <!-- 显示推荐文章和评论 -->



  <article class="post white-box comments">
    <section class="article typo">
      <h4><i class="fas fa-comments fa-fw" aria-hidden="true"></i>&nbsp;Comments</h4>
      
      
      
      
        <section id="comments">
          <div id="valine_container" class="valine_thread">
            <i class="fas fa-spinner fa-spin fa-fw"></i>
          </div>
        </section>
      
    </section>
  </article>






<!-- 根据页面mathjax变量决定是否加载MathJax数学公式js -->



  <script>
    window.subData = {
      title: 'Spring探究之AOP',
      tools: true
    }
  </script>


</div>
<aside class='l_side'>
  
    
    
      
        
          
          
        
          
          
        
          
          
        
          
          
        
          
          
        
      
        
          
          
        
          
          
        
          
          
            
              
  <section class='widget toc-wrapper'>
    
<header class='pure'>
  <div><i class="fas fa-list fa-fw" aria-hidden="true"></i>&nbsp;&nbsp;TOC</div>
  
    <!-- <div class='wrapper'><a class="s-toc rightBtn" rel="external nofollow noopener noreferrer" href="javascript:void(0)"><i class="fas fa-thumbtack fa-fw"></i></a></div> -->
  
</header>

    <div class='content pure'>
      <ol class="toc"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-什么是AOP"><span class="toc-text">1. 什么是AOP</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-AOP的基本使用"><span class="toc-text">2. AOP的基本使用</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-AOP源码分析"><span class="toc-text">3. AOP源码分析</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-AOP总结"><span class="toc-text">4. AOP总结</span></a></li></ol>
    </div>
  </section>


            
          
        
          
          
        
          
          
        
      
        
          
          
        
          
          
        
          
          
        
          
          
        
          
          
        
      
    

  
</aside>

<footer id="footer" class="clearfix">
  
  
    <div class="social-wrapper">
      
        
          <a href="/atom.xml"
            class="social fas fa-rss flat-btn"
            target="_blank"
            rel="external nofollow noopener noreferrer">
          </a>
        
      
        
          <a href="mailto:807920489@qq.com"
            class="social fas fa-envelope flat-btn"
            target="_blank"
            rel="external nofollow noopener noreferrer">
          </a>
        
      
        
          <a href="https://github.com/mike-zeng"
            class="social fab fa-github flat-btn"
            target="_blank"
            rel="external nofollow noopener noreferrer">
          </a>
        
      
    </div>
  
  <br>
  <div><p>Blog content follows the <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" target="_blank" rel="noopener">Attribution-NonCommercial-ShareAlike 4.0 International (CC BY-NC-SA 4.0) License</a></p>
</div>
  <div>
    Use
    <a href="https://xaoxuu.com/wiki/material-x/" target="_blank" class="codename">Material X</a>
    as theme
    
      , 
      total visits
      <span id="busuanzi_value_site_pv"><i class="fas fa-spinner fa-spin fa-fw" aria-hidden="true"></i></span>
      times
    
    . 
  </div>
</footer>
<script>setLoadingBarProgress(80);</script>


      <script>setLoadingBarProgress(60);</script>
    </div>
    <a class="s-top fas fa-arrow-up fa-fw" href='javascript:void(0)'></a>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>

  <script>
    var GOOGLE_CUSTOM_SEARCH_API_KEY = "";
    var GOOGLE_CUSTOM_SEARCH_ENGINE_ID = "";
    var ALGOLIA_API_KEY = "";
    var ALGOLIA_APP_ID = "";
    var ALGOLIA_INDEX_NAME = "";
    var AZURE_SERVICE_NAME = "";
    var AZURE_INDEX_NAME = "";
    var AZURE_QUERY_KEY = "";
    var BAIDU_API_ID = "";
    var SEARCH_SERVICE = "hexo" || "hexo";
    var ROOT = "/"||"/";
    if(!ROOT.endsWith('/'))ROOT += '/';
  </script>

<script src="//instant.page/1.2.2" type="module" integrity="sha384-2xV8M5griQmzyiY3CDqh1dn4z3llDVqZDqzjzcY+jCBCk/a5fXJmuZ/40JJAPeoU"></script>


  <script async src="https://cdn.jsdelivr.net/npm/scrollreveal@4.0.5/dist/scrollreveal.min.js"></script>
  <script type="text/javascript">
    $(function() {
      const $reveal = $('.reveal');
      if ($reveal.length === 0) return;
      const sr = ScrollReveal({ distance: 0 });
      sr.reveal('.reveal');
    });
  </script>


  <script src="https://cdn.jsdelivr.net/npm/node-waves@0.7.6/dist/waves.min.js"></script>
  <script type="text/javascript">
    $(function() {
      Waves.attach('.flat-btn', ['waves-button']);
      Waves.attach('.float-btn', ['waves-button', 'waves-float']);
      Waves.attach('.float-btn-light', ['waves-button', 'waves-float', 'waves-light']);
      Waves.attach('.flat-box', ['waves-block']);
      Waves.attach('.float-box', ['waves-block', 'waves-float']);
      Waves.attach('.waves-image');
      Waves.init();
    });
  </script>


  <script async src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-busuanzi@2.3/js/busuanzi.pure.mini.js"></script>




  
  
  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-backstretch/2.0.4/jquery.backstretch.min.js"></script>
    <script type="text/javascript">
      $(function(){
        if ('.cover') {
          $('.cover').backstretch(
          ["https://cdn.jsdelivr.net/gh/mike-zeng/zeng_cdn/blog/image/background1.jpg", "https://cdn.jsdelivr.net/gh/mike-zeng/zeng_cdn/blog/image/background2.jpg"],
          {
            duration: "6000",
            fade: "2500"
          });
        } else {
          $.backstretch(
          ["https://cdn.jsdelivr.net/gh/mike-zeng/zeng_cdn/blog/image/background1.jpg", "https://cdn.jsdelivr.net/gh/mike-zeng/zeng_cdn/blog/image/background2.jpg"],
          {
            duration: "6000",
            fade: "2500"
          });
        }
      });
    </script>
  









  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  
    
      
<script src="https://cdn.jsdelivr.net/gh/xaoxuu/volantis@1.0.6/js/volantis.min.js"></script>

    
  
  <script>
  var GUEST_INFO = ['nick','mail','link'];
  var guest_info = 'nick,mail,link'.split(',').filter(function(item){
    return GUEST_INFO.indexOf(item) > -1
  });
  var notify = 'true' == true;
  var verify = 'true' == true;
  var valine = new Valine();
  valine.init({
    el: '#valine_container',
    notify: notify,
    verify: verify,
    guest_info: guest_info,
    
    appId: "03wbpQpd8dcMWzsThoJ6MPQA-gzGzoHsz",
    appKey: "8KLQBX5uu2Reuus89jvRTphH",
    placeholder: "快来评论吧~",
    pageSize:'10',
    avatar:'retro',
    lang:'zh-cn',
    highlight:'true'
  })
  </script>



  
<script src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-material-x@19.11/js/app.js"></script>



  
<script src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-material-x@19.11/js/search.js"></script>





<!-- 复制 -->
<script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
<script>
  let COPY_SUCCESS = "Copied";
  let COPY_FAILURE = "Copy failed";
  /*页面载入完成后，创建复制按钮*/
  !function (e, t, a) {
    /* code */
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '  <i class="fa fa-copy"></i><span>Copy</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });

      clipboard.on('success', function(e) {
        //您可以加入成功提示
        console.info('Action:', e.action);
        console.info('Text:', e.text);
        console.info('Trigger:', e.trigger);
        success_prompt(COPY_SUCCESS);
        e.clearSelection();
      });
      clipboard.on('error', function(e) {
        //您可以加入失败提示
        console.error('Action:', e.action);
        console.error('Trigger:', e.trigger);
        fail_prompt(COPY_FAILURE);
      });
    }
    initCopyCode();

  }(window, document);

  /**
   * 弹出式提示框，默认1.5秒自动消失
   * @param message 提示信息
   * @param style 提示样式，有alert-success、alert-danger、alert-warning、alert-info
   * @param time 消失时间
   */
  var prompt = function (message, style, time)
  {
      style = (style === undefined) ? 'alert-success' : style;
      time = (time === undefined) ? 1500 : time*1000;
      $('<div>')
          .appendTo('body')
          .addClass('alert ' + style)
          .html(message)
          .show()
          .delay(time)
          .fadeOut();
  };

  // 成功提示
  var success_prompt = function(message, time)
  {
      prompt(message, 'alert-success', time);
  };

  // 失败提示
  var fail_prompt = function(message, time)
  {
      prompt(message, 'alert-danger', time);
  };

  // 提醒
  var warning_prompt = function(message, time)
  {
      prompt(message, 'alert-warning', time);
  };

  // 信息提示
  var info_prompt = function(message, time)
  {
      prompt(message, 'alert-info', time);
  };

</script>


<!-- fancybox -->
<script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>
<script>
  let LAZY_LOAD_IMAGE = "";
  $(".article-entry").find("fancybox").find("img").each(function () {
      var element = document.createElement("a");
      $(element).attr("data-fancybox", "gallery");
      $(element).attr("href", $(this).attr("src"));
      /* 图片采用懒加载处理时,
       * 一般图片标签内会有个属性名来存放图片的真实地址，比如 data-original,
       * 那么此处将原本的属性名src替换为对应属性名data-original,
       * 修改如下
       */
       if (LAZY_LOAD_IMAGE) {
         $(element).attr("href", $(this).attr("data-original"));
       }
      $(this).wrap(element);
  });
</script>





  <script>setLoadingBarProgress(100);</script>
</body>
</html>

---
title: TCP数据流与窗口管理
sidebar: [grid, toc, tags] # 放置任何你想要显示的侧边栏部件
categories: [计算机网络, 传输层]
date: 2019-12-22
tags:
- 计算机网络
- tcp
---

##### 1. 交互式通信

- 什么是交互式通信

  交互式通信是指双方通信时传输一些较小的信息，这些信息会封装成**较小的报文段**，但是**又希望延迟尽量低**。这里的问题在于，TCP每次传输的信息量很少（也就是说大部分都是TCP首部）降低了网络的利用率，但是如果让TCP发送的数据多一点(比如说几个小数据累积在一起后发送)又会带来较大的时延，如何平衡这两者关系是交互式通信要研究的问题。

- 交互式通信是如何做的

  通常交互式通信，用户在一端输入信息希望马上看到另一方的回显信息，采取的做法是首先发送方向接收方发送一个报文，接收方收到报文后要对其进行确认，但是不同的是接收方会把回显信息与ACK信息一起返回，发生放收到后再进行确认，通过这样的优化，可以少发一个报文并且发送方也可以少等一个报文发送的时间。

  

##### 2. 延迟确认

TCP不会对每一个数据包都返回ACK确认,而是**采取累积确认**的方式，这样就可以大量减少网络中的ACK数据包，但是TCP不能够延迟任意时长，否则发送方会超时，不同的操作系统实现的延时时间不一样。延时确认不能用在对时延要求高的应用上。



##### 3. Nagle算法

- Nagle算法解决了什么问题

  Nagle算法是一种拥塞控制算法。每次发送少量的数据时，TCP的头部和IP的首部会有很大的开销，这会造成相当高的网络传输代价（这种代价对局域网没有影响，对广域网可能造成拥塞，如糊涂窗口综合征），Nagle算法就是用来解决这种**小包可能导致网络拥塞的问题**。

- Nagle算法的原理

  Nagle算法要求，当一个TCP连接中有在传数据（已经发生但还未经确认），小的报文段（长度小于SMSS，SMSS是指发送方能够发送的最大数据段的长度）就不能被发送，直到所有的在传数据都收到ACK，TCP会将小数据收集整合到一个报文段中发送。大的报文段不受Nagle算法的影响，实际上Nagle算法对于小的报文段来说就是一个停止等待协议。

- Nagle算法为什么有效

  因为要等到所有在传数据收到ACK才发小数据，那么ACK返回的越快，小数据包传输也就越快，如果是时延比较高的广域网中，ACK返回就会越慢，小数据被发送出去的速度也会变慢，这样小数据包就不会加重网络的阻塞。也就是说RTT可以控制发包速率。

- 如果延时ACK与Nagle算法结合会发生什么

  延时ACK与Nagle算法直接结合使用效果会很差，延迟确认会使得接受方推迟发送ACK报文，而使用了Nagle算法的发送方又要等到接收到ACK报文才发送，**导致网络处于空闲状态**。

- Nagle算法不适用于什么场景

  **要求时延尽量小的应用不适合使用Nagle算法**如网络游戏，远程控制等。



##### 4. 流量控制与窗口管理

TCP使用滑动窗口来实现流量控制，”流量控制“控制的是发送方的发送速率，它与拥塞控制不同的是，流量控制考虑的是接收方的接受能力（如果接收方接受能力差，接收缓存满了，发送方发过来的数据包就会被丢弃然后重传，显然这是不必要的）

- 滑动窗口的机制

  发送方和接收方都会维护一个窗口，称为**发送窗口**和**接收窗口**，它们都是**以字节为单位**的。

  - 发送窗口

    假设发送窗口向右移动，则发送窗口左边的数据是**已经发送且确认**了的可以从缓存区中清除，发送窗口右边的数据是**还不能发送的**，发送窗口内部维护了一个指针，指针的左边是**已发送但还未确认**的数据，指针右边是**可发送但还未发送**的数据。

  - 接收窗口

    接收窗口左边界的数据是**已接受并确认**的数据，右窗口是**不能接收**的数据，窗口内部是**接受后还未确认**的数据

- 如何利用滑动窗口实现流量控制

  TCP发送端向接收端使用滑动窗口机制发送数据，发送速率取决于发送方的发送窗口大小，所以为了实现流量控制，接收方会携带窗口大小信息来控制发送方发送窗口的大小，以达到发送端流量控制的目的。

- 零窗口问题

  流量控制过程中的一种极端情况是，接收端告知发送端窗口为0，这样发送端就无法发送数据给接收端了，当接收端窗口大小恢复为非零值，会给发送端传输一个**窗口更新报文**告知其可以继续发送数据，但是如果发送方发送的一个包含窗口更新的ACK丢失了，通信双方就会一直处于等待状态。

- TCP持续计时器

  **持续计时器解决了零窗口问题**，发送端会维护一个持续计时器间歇性的查询接收端，看其窗口是否已经增长。计时器会触发发送端发送一个**窗口探测报文**，接收端会回一个带有窗口信息的ACK报文。采用指数退避的方式来设置持续计时器的时间。

- 糊涂窗口综合症

  糊涂窗口综合症是指当发送端应用进程产生数据很慢、或接收端应用进程处理接收缓冲区数据很慢，或二者兼而有之；就会使**应用进程间传送的报文段很小，特别是有效载荷很小**； 极端情况下，有效载荷可能只有1个字节；传输开销有40字节(20字节的IP头+20字节的TCP头) 这种现象。

  发送方和接收方都可能会引发糊涂窗口综合征

  - 发送方

    发送方产生的数据比较慢，每次产生的数据都很小。对于**发送方不应该发送小的报文段，可以使用Nagle算法来控制何时发送**

  - 接收方

    接收方的原因是进程处理缓存中的数据不及时，然后通知了一个较小的窗口给发送方。对于**接收方应该避免通告小的窗口值，可以使用延迟确认的方式等缓存中的数据被情空了再告知窗口值**。

##### 5. 紧急机制

**带外数据**

传输层协议使用带外数据（out-of-band，OOB）来发送一些重要的数据，如果通信一方有重要的数据需要通知对方时，协议能够将这些数据快速地发送到对方。为了发送这些数据，协议一般不使用与普通数据相同的通道，而是使用另外的通道。

TCP协议没有真正意义上的带外数据。为了发送重要协议，TCP提供了一种称为紧急模式（urgent mode）的机制。TCP协议在数据段中设置URG位，表示进入紧急模式。接收方可以对紧急模式采取特殊的处理。

**紧急模式**

TCP头部有一个位字段URG标志紧急数据，当URG位为1时，TCP头部节点的紧急指针位会记录一个偏移量，指向紧急数据的最后一位，在读取到紧急指针所指向的位置之前，TCP的接受进程都处于紧急状态，当读取到紧急数据后一位时，恢复到正常状态。

当URG置1时，发送方应用进程就告诉发送方的TCP有紧急数据要传送。于是发送方TCP就把紧急数据插入到本报文段数据的最前面。

在紧急指针字段的具体实现上，由于过去的文档有错误或不太明确的地方，因而导致对有关RFC文档产生了不同的理解。

****

*参考：《TCP/IP详解 卷1：协议》Kevin R. Fall W.Richard Stevens*

